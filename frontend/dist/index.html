<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Mapa y Formulario con Ubicaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map {
      height: 300px;
      width: 100%;
    }
  </style>
</head>

<body class="bg-light">

  <div class="container py-5">
    <div class="row justify-content-center">
      <!-- Tarjeta del mapa -->
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header text-center">
            Mapa de Piedecuesta
          </div>
          <div class="card-body">
            <div id="map"></div>
          </div>
        </div>
      </div>

      <!-- Tarjeta del formulario -->
      <div class="col-md-6 mt-4 mt-md-0">
        <div class="card shadow">
          <div class="card-header text-center">
            Formulario
          </div>
          <div class="card-body">
            <form id="form_cliente">
              <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ingresa tu nombre">
              </div>

              <div class="mb-3">
                <label for="ip" class="form-label">IP</label>
                <input type="text" class="form-control" id="ip" name="ip" placeholder="Ingresa la IP">
              </div>

              <div class="mb-3">
                <label for="observacion" class="form-label">Observaci√≥n</label>
                <textarea class="form-control" id="observacion" name="observacion"></textarea>
              </div>

              <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select class="form-select" id="estado" name="estado">
                  <option value="">-- Selecciona estado --</option>
                  <option value="Activo">Activo</option>
                  <option value="Inactivo">Inactivo</option>
                  <option value="Pendiente">Pendiente</option>
                </select>
              </div>


              <!-- Campos de coordenadas -->
              <div class="mb-3">
                <label class="form-label">Ubicaci√≥n</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="latitud" name="latitud" readonly placeholder="Latitud">
                  <input type="text" class="form-control" id="longitud" name="longitud" readonly placeholder="Longitud">
                  <button type="button" class="btn btn-outline-primary" onclick="getLocation()">üìç Mi ubicaci√≥n</button>
                </div>
              </div>

              <div class="mb-3">
                <label for="fechaInstalacion" class="form-label">Fecha de instalaci√≥n</label>
                <input type="datetime-local" class="form-control" id="fechaInstalacion" name="fechaInstalacion">
              </div>

              <button type="submit" class="btn btn-primary w-100">Enviar</button>
            </form>


          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Inicializa el mapa en Piedecuesta
    const map = L.map('map').setView([6.9931457, -73.0861263], 17);

    // Capa de tiles de OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // √çcono personalizado
    const customIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      iconSize: [16, 16],
      iconAnchor: [8, 16],
      popupAnchor: [0, -16]
    });

    // Marcador inicial
    let marker = L.marker([6.9931457, -73.0861263], { icon: customIcon })
      .addTo(map)
      .bindPopup("Piedecuesta, Santander");

    // Funci√≥n para obtener ubicaci√≥n actual
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        document.getElementById("ubicacion").value = "Geolocalizaci√≥n no soportada";
      }
    }


    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          //document.getElementById("ubicacion").value = "Permiso de ubicaci√≥n denegado";
          break;
        case error.POSITION_UNAVAILABLE:
          //document.getElementById("ubicacion").value = "Ubicaci√≥n no disponible";
          break;
        case error.TIMEOUT:
          //document.getElementById("ubicacion").value = "Tiempo de espera agotado";
          break;
        default:
        //document.getElementById("ubicacion").value = "Error desconocido";
      }
    }

    function showPosition(position) {
      const lat = position.coords.latitude.toFixed(6);
      const lon = position.coords.longitude.toFixed(6);

      // ‚úÖ Cargar en los inputs separados
      document.getElementById("latitud").value = lat;
      document.getElementById("longitud").value = lon;

      // Mover mapa y marcador
      map.setView([lat, lon], 17);
      marker.setLatLng([lat, lon]).bindPopup("Tu ubicaci√≥n actual").openPopup();
    }

    // Evento doble clic en el mapa
    map.on('dblclick', function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lon = e.latlng.lng.toFixed(6);

      // ‚úÖ Cargar en los inputs separados
      document.getElementById("latitud").value = lat;
      document.getElementById("longitud").value = lon;

      // Mover marcador
      marker.setLatLng([e.latlng.lat, e.latlng.lng])
        .bindPopup("Ubicaci√≥n seleccionada")
        .openPopup();
    });

    document.getElementById("clienteForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      // Ajustar fecha a ISO si existe
      if (data.fechaInstalacion) {
        data.fechaInstalacion = new Date(data.fechaInstalacion).toISOString();
      }

      // Convertir latitud/longitud a n√∫mero
      if (data.latitud) data.latitud = parseFloat(data.latitud);
      if (data.longitud) data.longitud = parseFloat(data.longitud);

      try {
        const response = await fetch("/api/cliente", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log("Respuesta:", result);
      } catch (err) {
        console.error("Error:", err);
      }
    });

  </script>
</body>

</html>